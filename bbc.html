<head>
<link type="text/css" rel="stylesheet" href="css/styles.css">
<script type="text/javascript" src="js/jquery-1.4.1.min.js"></script>
<script type="text/javascript" src="js/json2.js"></script>
<script>

var bg = chrome.extension.getBackgroundPage();

function main() {
  var favs = localStorage["fav_services"];

  if (!favs) {
    $('#welcome').fadeIn(); 
    return;
  }

  var best_choice = bg.best_choice;

  var services = [];
  jQuery.each(favs.split(','), function(index, key) {
    var outlet = '';
    if (best_choice[key]) {
      outlet = best_choice[key] + "/"; 
    }
    services.push("http://www.bbc.co.uk/"+key+"/programmes/schedules/"+outlet+"upcoming.json");
    //services.push("upcoming.json");
  });

  displayList(services);
}

function displayList(s) {
  jQuery.each(s, function(index, url) {
    $.ajax({
      url: url,
      dataType: 'json',
      success: function(data) {
        buildServiceLabel(data);
      },
      error: function(data) {
        $("#services").append("<li>oops, there has been a problem fetching the data</li>");
      }
    });
  });
}

function buildServiceLabel(data) {
  var now = nowData(data);
  var next = nextData(data);
  var service = serviceData(data);
  
  $("#services").append('<li><div class="network">'+service+'</div><div class="now">'+now+'</div><div class="next">'+next+'</div></li>');
}

function nowData(data) {
  if (data["schedule"]["now"]) { 
    var pid = data["schedule"]["now"]["broadcast"]["programme"]["pid"];
    var promo_img = 'http://node2.bbcimg.co.uk/iplayer/images/episode/'+pid+'_86_48.jpg';
    var start = iso8601ToDate( data["schedule"]["now"]["broadcast"]["start"] );
    var end = iso8601ToDate( data["schedule"]["now"]["broadcast"]["end"] );
    var title = data["schedule"]["now"]["broadcast"]["programme"]["display_titles"]["title"];
    var subtitle = data["schedule"]["now"]["broadcast"]["programme"]["short_synopsis"];
    var link = "chrome.tabs.create({url: '"+bg.programmes_url + pid+"'});"; 
    return '<img class="promo" src="'+promo_img+'">' +
           '<p class="startend">'+dateToHHMM(start)+' - '+dateToHHMM(end)+'</p>' +
           '<p class="title"><a href="#" onclick="'+link+'">'+title+'</a></p>' +
           '<p class="subtitle">'+subtitle+'</p>';
  } else {
    return 'not available';
  }
}

function nextData(data) {
  if (data["schedule"]["next"]) {
    var pid = data["schedule"]["next"]["broadcasts"][0]["programme"]["pid"];
    var promo_img = 'http://node2.bbcimg.co.uk/iplayer/images/episode/'+pid+'_86_48.jpg';
    var start = iso8601ToDate( data["schedule"]["next"]["broadcasts"][0]["start"] );
    var end = iso8601ToDate( data["schedule"]["next"]["broadcasts"][0]["end"] );
    var title = data["schedule"]["next"]["broadcasts"][0]["programme"]["display_titles"]["title"];
    var subtitle = data["schedule"]["next"]["broadcasts"][0]["programme"]["short_synopsis"];
    var link = "chrome.tabs.create({url: '"+bg.programmes_url + pid+"'});"; 
    return '<img class="promo" src="'+promo_img+'">' +
           '<p class="startend">'+dateToHHMM(start)+' - '+dateToHHMM(end)+'</p>' +
           '<p class="title"><a href="#" onclick="'+link+'">'+title+'</a></p>' +
           '<p class="subtitle">'+subtitle+'</p>';
  } else {
    return '';
  }
}

function serviceData(data) {
  var stations = bg.stations;
  var service = data["schedule"]["service"];
  var key = stations[service["key"]];
  var type = service["type"];
  var path = 'http://www.bbc.co.uk/iplayer/img/station_logos/'+key+'.png';
  var link = "chrome.tabs.create({url: 'http://www.bbc.co.uk/iplayer/"+type+"/"+key+"'});"; 
  return '<a href="#" onclick="'+link+'"><img src="'+path+'" /></a>'
}

function dateToHHMM(date) {
  var hours = date.getHours() < 10 ? '0'+date.getHours() : date.getHours(); 
  var mins = date.getMinutes() < 10 ? '0'+date.getMinutes() : date.getMinutes(); 
  return hours + ':' + mins;  
}

function iso8601ToDate(time) {
  var date = new Date(); 
  date.setTime( Date.parse((time || "").replace(/-/g,"/").replace(/[TZ]/g," ")) );
  return date; 
}

</script>
</head>
<body onload="javascript:main()" id="popup">
  <div id="content">
    <div id="welcome">
      <h1>BBC Now and Next information</h1>
      <p>Welcome. To get started, you need to select some stations to display. Go to the <a href="#" onclick="chrome.tabs.create({url: 'chrome://extensions'});">Extensions page</a> and click the <strong>Options</strong> button for this extension.</p>
    </div>
    <div id="">
      <ul id="services"></ul>
    </div>
  </div>
</body>
</html>
